{% extends 'base.html' %}
{% load static %}

{% block content %}
{% if is_logged_in %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">تکمیل خرید</h1>
    
    <!-- Checkout Steps -->
    <div class="flex items-center mb-8">
        <div class="flex-1">
            <div class="border-2 border-blue-500 rounded-full h-12 w-12 flex items-center justify-center bg-blue-500 text-white">1</div>
            <span class="text-sm mt-2 block text-center">سبد خرید</span>
        </div>
        <div class="h-1 flex-1 bg-blue-500"></div>
        <div class="flex-1">
            <div class="border-2 border-blue-500 rounded-full h-12 w-12 flex items-center justify-center bg-blue-500 text-white">2</div>
            <span class="text-sm mt-2 block text-center">اطلاعات ارسال</span>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Shipping Information -->
        <div class="md:col-span-2">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">آدرس تحویل</h2>
                
                {% if addresses %}
                <div class="space-y-4 mb-6">
                    {% for address in addresses %}
                    <div class="border rounded-lg p-4 cursor-pointer hover:border-blue-500">
                        <input type="radio" name="address" value="{{ address.id }}" class="ml-2">
                        <div class="mt-2">
                            <p>{{ address.address_line }}</p>
                            <p class="text-gray-600">{{ address.city }}، {{ address.state }}</p>
                            <p class="text-gray-600">کد پستی: {{ address.postal_code }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <form id="addressForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">آدرس</label>
                        <input type="text" name="address_line" class="w-full border rounded-md p-2">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">شهر</label>
                            <input type="text" name="city" class="w-full border rounded-md p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">استان</label>
                            <input type="text" name="state" class="w-full border rounded-md p-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">کد پستی</label>
                        <input type="text" name="postal_code" class="w-full border rounded-md p-2">
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">کد تخفیف</h2>
                <div class="flex">
                    <input type="text" id="discountCode" class="flex-1 border rounded-r-md p-2" placeholder="کد تخفیف خود را وارد کنید">
                    <button class="bg-blue-500 text-white px-6 py-2 rounded-l-md hover:bg-blue-600">اعمال</button>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="md:col-span-1">
            <div class="bg-white rounded-lg shadow p-6 sticky top-6">
                <h2 class="text-xl font-semibold mb-4">خلاصه سفارش</h2>
                
                {% if checkout_preview %}
                <div class="space-y-4 mb-6">
                    {% for item in checkout_preview.items %}
                    <div class="flex justify-between">
                        <span>{{ item.product_name }} × {{ item.quantity }}</span>
                        <span>{{ item.price|floatformat:0 }} تومان</span>
                    </div>
                    {% endfor %}
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between font-semibold">
                        <span>جمع کل</span>
                        <span>{{ checkout_preview.total_price|floatformat:0 }} تومان</span>
                    </div>
                </div>
                {% endif %}

                <button id="submitOrder" class="w-full bg-green-500 text-white py-3 rounded-md mt-6 hover:bg-green-600">
                    ثبت سفارش
                </button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.getElementById('submitOrder').addEventListener('click', async function() {
    const selectedAddress = document.querySelector('input[name="address"]:checked');
    const discountCode = document.getElementById('discountCode').value;
    
    let addressData;
    if (selectedAddress) {
        // Use existing address
        addressData = {
            id: selectedAddress.value
        };
    } else {
        // Use form data
        const form = document.getElementById('addressForm');
        const formData = new FormData(form);
        addressData = Object.fromEntries(formData);
    }

    try {
        const response = await fetch('http://127.0.0.1:8000/api/checkout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: "include",
            body: JSON.stringify({
                shipping_address: addressData,
                discount_code: discountCode || undefined
            })
        });

        if (response.ok) {
            const data = await response.json();
            // Redirect to order confirmation page
            window.location.href = `#`;
        } else {
            const error = await response.json();
            alert(error.error || 'خطا در ثبت سفارش');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('خطا در ارتباط با سرور');
    }
});

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
</script>
{% endblock %}
{% else %}
<p> لاگین کنید </p>
{% endif %}
{% endblock %}